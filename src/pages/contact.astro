---
import Layout from "../layouts/layout.astro";
---

<Layout title="Confidentialité">
    <!-- Conteneur principal -->
    <div class="max-w-[900px] mx-auto px-4">
      <div class="text-center">
        <!-- Avatar en cercle -->
        <div class="flex mt-12 justify-center mx-auto mb-6">
          <div
            class="rounded-full border-4 border-gray-200 w-32 h-32 flex items-center justify-center"
          >
            <img
              src="img/kw.webp"
              alt="ma photo"
              class="rounded-full w-full h-auto"
            />
          </div>
        </div>

        <!-- mon contact -->
        <div>
          <h2 class="text-xl mb-2">Nous contacter</h2>
            <p class="mb-4">
              <button 
                type="button" 
                popovertarget="contactDPO" 
                class="hover:text-heading transition-colors font-medium cursor-pointer"
              >
                contact@esportify.com
              </button>
            </p>
            <div class="mb-4 relative" x-data="{ copied: false }">
              <span 
                class="hover:text-heading transition-colors font-medium cursor-pointer" 
                x-on:click="
                  navigator.clipboard.writeText('+33 6 12 34 56 78');
                  copied = true;
                  setTimeout(() => copied = false, 1200)
                "
              >
                +33 6 12 34 56 78
              </span>
              <span 
                class="ml-3 text-sm text-green-500 copy-notification absolute"
                :class="{ 'copy-notification-visible': copied }"
              >
                numéro copié
              </span>
            </div>
        </div>
      </div>

      <!--Politique de confidentialité-->
      <section class="my-6 p-6 bg-[#161215] rounded-lg">
        <h3 class="text-2xl mb-6 font-medium text-heading">Politique de confidentialité</h3>
        
        <div class="space-y-6 text-sm">
          <div>
            <h4 class="text-lg mb-2 font-medium">Introduction</h4>
            <p>
              Chez Esportify, nous prenons votre vie privée au sérieux. Cette politique explique simplement quelles informations nous collectons, 
              comment nous les utilisons et comment nous les protégeons.
            </p>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Données collectées</h4>
            <p>
              Nous collectons uniquement les données nécessaires à votre utilisation du service :
            </p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Votre nom d'utilisateur et votre adresse email lors de l'inscription</li>
              <li>Votre mot de passe (toujours stocké de manière sécurisée)</li>
              <li>Les événements que vous créez (si vous êtes organisateur)</li>
              <li>Les événements que vous ajoutez en favoris</li>
              <li>Votre rôle sur la plateforme (visiteur, joueur, organisateur ou administrateur)</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Utilisation de vos données</h4>
            <p>Vos données sont utilisées exclusivement pour :</p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Créer et gérer votre compte utilisateur</li>
              <li>Vous permettre de créer et de participer aux événements</li>
              <li>Vous identifier lors de vos connexions</li>
              <li>Afficher les événements que vous avez mis en favoris</li>
              <li>Vous permettre de gérer vos propres événements (si vous êtes organisateur)</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Protection de vos données</h4>
            <p>Votre sécurité est notre priorité. Voici les mesures que nous prenons :</p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Utilisation de jetons JWT (JSON Web Tokens) pour stocker votre identifiant et votre rôle</li>
              <li>Deux options de stockage à votre choix :
                <ul class="list-disc list-inside ml-4 mt-1">
                  <li><strong>Session temporaire</strong> : Informations conservées pendant la durée de votre session</li>
                  <li><strong>Se souvenir de moi</strong> : Informations conservées pour vos prochaines connexions</li>
                </ul>
              </li>
              <li>Suppression sécurisée de votre jeton lors de la déconnexion</li>
              <li>Cryptage de votre mot de passe avant stockage dans notre base de données</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Partage des données</h4>
            <p>Notre approche concernant vos données :</p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Nous ne vendons pas vos données personnelles</li>
              <li>Nous ne partageons pas vos informations avec des tiers</li>
              <li>Nous ne collectons pas plus d'informations que nécessaire</li>
              <li>Certaines informations publiques comme votre nom d'utilisateur sont visibles pour les autres utilisateurs</li>
              <li>Si vous êtes organisateur, votre nom sera affiché comme créateur de vos événements</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Vos droits RGPD</h4>
            <p>Conformément au Règlement Général sur la Protection des Données (RGPD), vous disposez des droits suivants :</p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Droit d'accès à vos données personnelles</li>
              <li>Droit de rectification et de mise à jour de vos données</li>
              <li>Droit à l'effacement (droit à l'oubli)</li>
              <li>Droit d'opposition au traitement de vos données</li>
              <li>Droit à la portabilité de vos données</li>
            </ul>
            <p class="mt-2">
              Pour exercer ces droits ou pour toute question concernant vos données personnelles,
              <button 
                type="button" 
                popovertarget="contactDPO" 
                class="text-red-600 hover:text-heading transition-colors cursor-pointer"
              >
                contactez-nous
              </button>.
            </p>
          </div>

          <div>
            <h4 class="text-lg mb-2 font-medium">Durée de conservation</h4>
            <p>Vos données sont conservées :</p>
            <ul class="list-disc list-inside space-y-1 mt-2 ml-4">
              <li>Information de connexion temporaire : jusqu'à la fermeture de votre navigateur</li>
              <li>Information de connexion prolongée (option "Se souvenir de moi") : jusqu'à votre déconnexion manuelle</li>
              <li>Données de compte : tant que votre compte reste actif (possibilité de suppression sur demande)</li>
            </ul>
          </div>

          <div class="mt-8 text-center text-xs">
            <p>Cette politique a été mise à jour le 5 avril 2025.</p>
          </div>
        </div>
      </section>
    </div>      
      <!-- Popup de formulaire de contact -->
      <div 
        class="rounded resize max-w-[900px] border border-popupEvent overflow-y-auto" 
        id="contactDPO" 
        popover
      >
        <div class="flex justify-between align-middle bg-popupEvent">
          <h2 class="text-left flex-1 pl-2 cursor-move select-none py-1 -translate-y-0.5">
            <span class="-translate-y-1 mr-1">☎️</span>Contact
          </h2>
          <button class="text-xl px-2 select-none" popovertarget="contactDPO">
            X
          </button>
        </div>

        <form 
          id="formContact" 
          class="inset-0 w-full rounded max-w-[900px] mx-auto items-center justify-center z-50 px-5 py-2 transition-opacity"
          action="https://api.web3forms.com/submit" 
          method="POST"
        >
          <!-- Web3Forms Access Key -->
          <input type="hidden" name="access_key" value="2dcc3f1b-036f-48a7-987a-cdada0d05ae5">
          
          <!-- Sujet du message -->
          <input type="hidden" name="subject" value="Demande RGPD - Esportify">

          <!-- Conteneur flex pour nom et email -->
          <div class="flex flex-col md:flex-row gap-4 mb-4">
            <!-- Nom -->
            <div class="flex-1">
              <label for="name" class="block mb-1 text-sm font-medium">Nom</label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="bg-[#161215] text-text w-full border border-[#4d2d45] rounded px-3 py-2"
                placeholder="Votre nom"
              />
            </div>

            <!-- Email -->
            <div class="flex-1">
              <label for="email" class="block mb-1 text-sm font-medium">Email</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="bg-[#161215] text-text w-full border border-[#4d2d45] rounded px-3 py-2"
                placeholder="votre@email.com"
              />
            </div>
          </div>

          <!-- Message -->
          <div>
            <label for="message" class="block mb-1 text-sm font-medium">Message</label>
            <textarea
              id="message"
              name="message"
              required
              rows="8"
              class="bg-[#161215] text-text w-full border border-[#4d2d45] flex-1 rounded px-3 py-2 min-h-40 min-w-72"
              placeholder="Votre message concernant vos données personnelles..."
            ></textarea>
          </div>

          <!-- Honeypot pour éviter le spam -->
          <input type="checkbox" name="botcheck" class="hidden" style="display: none;">

          <!-- Bouton d'envoi avec feedback -->
          <div>
            <button
              type="submit"
              id="submitButton"
              class="w-full bg-popupEvent hover:bg-[#532447] text-white px-4 py-2 mt-5 mb-3 rounded transition-colors flex items-center justify-center"
            >
              <!-- Contenu du bouton sera géré dynamiquement par TS -->
              <span id="buttonContent">Envoyer la demande</span>
            </button>
            
            <!-- Zone de notification -->
            <div id="formNotification" class="mt-2 rounded px-3 py-2 hidden"></div>
          </div>
        </form>
      </div>
    </div>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Configuration du popup déplaçable
    configureDraggablePopup();
    
    // Configuration du formulaire
    configureContactForm();
  });

  /**
   * Configure le popup déplaçable
   */
  function configureDraggablePopup(): void {
    const popupMovable = document.getElementById("contactDPO");
    if (!popupMovable) return;
    
    const header = popupMovable.querySelector("h2");
    if (!header) return;
    
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let offsetX = 0;
    let offsetY = 0;

    // Gestionnaire pour le début du drag
    header.addEventListener("mousedown", function(e: MouseEvent) {
      isDragging = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
      popupMovable.classList.add("grabbing");
    });

    // Gestionnaire pour le déplacement
    document.addEventListener("mousemove", function(e: MouseEvent) {
      if (!isDragging) return;
      
      offsetX = e.clientX - startX;
      offsetY = e.clientY - startY;
      
      // Utilisation de `transform` pour un déplacement fluide
      popupMovable.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
    });

    // Gestionnaire pour la fin du drag
    document.addEventListener("mouseup", function() {
      isDragging = false;
      if (popupMovable) {
        popupMovable.classList.remove("grabbing");
      }
    });
  }

  /**
   * Configure le formulaire de contact
   */
  function configureContactForm(): void {
    const form = document.getElementById("formContact") as HTMLFormElement;
    const submitButton = document.getElementById("submitButton") as HTMLButtonElement;
    const buttonContent = document.getElementById("buttonContent") as HTMLSpanElement;
    const notification = document.getElementById("formNotification") as HTMLDivElement;
    const popupMovable = document.getElementById("contactDPO");
    
    if (!form || !submitButton || !buttonContent || !notification) return;

    form.addEventListener("submit", async function(event) {
      event.preventDefault();
      
      // Mise à jour de l'interface pour l'état "envoi en cours"
      buttonContent.innerHTML = `
      <div class="flex gap-2">
        Envoi en cours...
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      <div />
      `;
      submitButton.disabled = true;
      
      try {
        const formData = new FormData(form);
        
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Mise à jour pour l'état "succès"
          submitButton.classList.remove("bg-popupEvent", "hover:bg-[#532447]");
          submitButton.classList.add("bg-green-600", "hover:bg-green-700");
          buttonContent.textContent = "Message envoyé !";
          
          // Afficher notification de succès
          notification.textContent = "Votre message a été envoyé avec succès.";
          notification.classList.remove("hidden", "bg-red-100", "text-red-700", "border-red-400");
          notification.classList.add("bg-green-100", "text-green-700", "border", "border-green-400");
          
          // Réinitialiser le formulaire
          form.reset();
          
          // Fermer le popup après un délai
          setTimeout(() => {
            if (popupMovable && 'hidePopover' in popupMovable) {
              (popupMovable as any).hidePopover();
            }
            
            // Réinitialiser le bouton
            notification.classList.add("hidden");
          }, 1200);
          setTimeout(() => {
            resetButton();
          }, 1200);
        } else {
          handleError("Une erreur est survenue lors de l'envoi du formulaire.");
        }
      } catch (error) {
        handleError("Une erreur est survenue lors de l'envoi du formulaire.");
        console.error('Erreur:', error);
      }
    });
    
    function handleError(message: string): void {
      // Mise à jour pour l'état "erreur"
      submitButton.classList.remove("bg-popupEvent", "hover:bg-[#532447]");
      submitButton.classList.add("bg-red-600", "hover:bg-red-700");
      buttonContent.textContent = "Échec de l'envoi";
      
      // Afficher notification d'erreur
      notification.textContent = message;
      notification.classList.remove("hidden", "bg-green-100", "text-green-700", "border-green-400");
      notification.classList.add("bg-red-100", "text-red-700", "border", "border-red-400");
      
      // Réinitialiser le bouton après un délai
      setTimeout(() => {
        resetButton();
      }, 3000);
    }
    
    function resetButton(): void {
      submitButton.disabled = false;
      submitButton.classList.remove("bg-green-600", "hover:bg-green-700", "bg-red-600", "hover:bg-red-700");
      submitButton.classList.add("bg-popupEvent", "hover:bg-[#532447]");
      buttonContent.textContent = "Envoyer la demande";
    }
  }
</script>

<style>
  #contactDPO {
    @apply bg-[#5e3554] text-text;
    opacity: 0;
    transition:
      display 0.3s,
      opacity 0.3s;
    transition-behavior: allow-discrete;
    &:popover-open {
      display: block;
      opacity: 1;
      @starting-style {
        opacity: 0;
      }
    }
  }
  
  #formContact {
    background: linear-gradient(to bottom, #251e23, #121012);
  }
  
  input,
  textarea {
    border: 1px solid #4d2d45;
  }
  
  .grabbing {
    cursor: grabbing;
  }

  .copy-notification {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.copy-notification-visible {
  opacity: 1;
}
</style>